<ul class="friends_list">
  <% @users.each do |user| %>
    <% next if user == current_user %>

    <li>
      <%= user.username %>

      <% if Friendship.can_friend?(current_user.id, user.id) %>
        <% friend_state = "can-friend" %>
      <% elsif Friendship.can_unfriend?(current_user.id, user.id) %>
        <% friend_state = "can-unfriend" %>
      <% end %>

      <span class="friend-buttons <%= friend_state %>">
        <button class="friend" data-id="<%= user.id %>">
          Friend them down!
        </button>
        <button class="unfriend" data-id="<%= user.id %>">
          Terminate friendship :-(
        </button>
      </span>
    </li>
  <% end %>
</ul>

<script>
  function toggleFriendButtons ($button) {
    $button
      .parents(".friend-buttons")
      .toggleClass("can-friend")
      .toggleClass("can-unfriend");
  }

  var BUTTON_METHODS = {
    "button.friend": "POST",
    "button.unfriend": "DELETE"
  };

  ["button.friend", "button.unfriend"].forEach(function (buttonClass) {
    $("ul.friends_list").on("click", buttonClass, function (event) {
      var $currentTarget = $(event.currentTarget);
      $.ajax({
        url: "/users/" + $currentTarget.attr("data-id") + "/friendship",
        type: BUTTON_METHODS[buttonClass],
        success: function () { toggleFriendButtons($currentTarget) }
      });
    });
  });
</script>
